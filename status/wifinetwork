#!/usr/bin/env bash

# wifi network status bar indicator for dwmblocks
# uses netcat and iw to get connection information

icon=""

notify() {
    dunstify --appname="wifi" --replace=1 "$1" "$2" --timeout="$3"
}

info=$(iw dev wlan0 link | grep SSID | xargs)
ssid=${info#"SSID: "}
signal=$(awk 'NR==3 {printf("%.0f%%",$3*10/7)}' /proc/net/wireless)
msg=""

airplane_mode=$(rfkill list | grep yes)

check_connection() {

    notify "Checking connection" "Please wait..." 0

    if [ ! -z "$airplane_mode" ]; then # check for airplane mode
        icon=""
        notify "Airplane mode active" "No signal" 7000
    elif [ -z "$ssid" ]; then # checking if we are connected to a wifi network
        icon=""
        notify "Connection lost" "No WiFi network" 7000
    else
        # checking internet connection
        if nc -z archlinux.org 443 > /dev/null 2>&1; then
            icon=""
            msg="Online"
        else
            icon=""
            msg="Offline"
        fi
        notify "$ssid" "$msg, signal: $signal\nRight click for options" 7000
    fi
}

case $BLOCK_BUTTON in
    1) check_connection ;;
    3) setsid -f $TERMINAL -e nmtui ;;
esac

printf "  %s\n" "$icon"
